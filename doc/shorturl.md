# å¿«é€Ÿæ„å»ºé«˜å¹¶å‘å¾®æœåŠ¡

[English](shorturl-en.md) | ç®€ä½“ä¸­æ–‡

## 0. ä¸ºä»€ä¹ˆè¯´åšå¥½å¾®æœåŠ¡å¾ˆéš¾

è¦æƒ³åšå¥½å¾®æœåŠ¡ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£å’ŒæŒæ¡çš„çŸ¥è¯†ç‚¹éå¸¸å¤šï¼Œä»å‡ ä¸ªç»´åº¦ä¸Šæ¥è¯´ï¼š

* åŸºæœ¬åŠŸèƒ½å±‚é¢
  1. å¹¶å‘æ§åˆ¶&é™æµï¼Œé¿å…æœåŠ¡è¢«çªå‘æµé‡å‡»å®
  2. æœåŠ¡æ³¨å†Œä¸æœåŠ¡å‘ç°ï¼Œç¡®ä¿èƒ½å¤ŸåŠ¨æ€ä¾¦æµ‹å¢å‡çš„èŠ‚ç‚¹
  3. è´Ÿè½½å‡è¡¡ï¼Œéœ€è¦æ ¹æ®èŠ‚ç‚¹æ‰¿å—èƒ½åŠ›åˆ†å‘æµé‡
  4. è¶…æ—¶æ§åˆ¶ï¼Œé¿å…å¯¹å·²è¶…æ—¶è¯·æ±‚åšæ— ç”¨åŠŸ
  5. ç†”æ–­è®¾è®¡ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œä¿éšœæ•…éšœèŠ‚ç‚¹çš„æ¢å¤èƒ½åŠ›

* é«˜é˜¶åŠŸèƒ½å±‚é¢
  1. è¯·æ±‚è®¤è¯ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
  2. é“¾è·¯è¿½è¸ªï¼Œç”¨äºç†è§£æ•´ä¸ªç³»ç»Ÿå’Œå¿«é€Ÿå®šä½ç‰¹å®šè¯·æ±‚çš„é—®é¢˜
  3. æ—¥å¿—ï¼Œç”¨äºæ•°æ®æ”¶é›†å’Œé—®é¢˜å®šä½
  4. å¯è§‚æµ‹æ€§ï¼Œæ²¡æœ‰åº¦é‡å°±æ²¡æœ‰ä¼˜åŒ–

å¯¹äºå…¶ä¸­æ¯ä¸€ç‚¹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ç”¨å¾ˆé•¿çš„ç¯‡å¹…æ¥è®²è¿°å…¶åŸç†å’Œå®ç°ï¼Œé‚£ä¹ˆå¯¹æˆ‘ä»¬åç«¯å¼€å‘è€…æ¥è¯´ï¼Œè¦æƒ³æŠŠè¿™äº›çŸ¥è¯†ç‚¹éƒ½æŒæ¡å¹¶è½å®åˆ°ä¸šåŠ¡ç³»ç»Ÿé‡Œï¼Œéš¾åº¦æ˜¯éå¸¸å¤§çš„ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ä¾èµ–å·²ç»è¢«å¤§æµé‡éªŒè¯è¿‡çš„æ¡†æ¶ä½“ç³»ã€‚[go-zeroå¾®æœåŠ¡æ¡†æ¶](https://github.com/tal-tech/go-zero)å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿã€‚

å¦å¤–ï¼Œæˆ‘ä»¬å§‹ç»ˆç§‰æ‰¿**å·¥å…·å¤§äºçº¦å®šå’Œæ–‡æ¡£**çš„ç†å¿µã€‚æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½å‡å°‘å¼€å‘äººå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ï¼ŒæŠŠç²¾åŠ›éƒ½æŠ•å…¥åˆ°äº§ç”Ÿä¸šåŠ¡ä»·å€¼çš„ä»£ç ä¸Šï¼Œå‡å°‘é‡å¤ä»£ç çš„ç¼–å†™ï¼Œæ‰€ä»¥æˆ‘ä»¬å¼€å‘äº†`goctl`å·¥å…·ã€‚

ä¸‹é¢æˆ‘é€šè¿‡çŸ­é“¾å¾®æœåŠ¡æ¥æ¼”ç¤ºé€šè¿‡[go-zero](https://github.com/tal-tech/go-zero)å¿«é€Ÿçš„åˆ›å»ºå¾®æœåŠ¡çš„æµç¨‹ï¼Œèµ°å®Œä¸€éï¼Œä½ å°±ä¼šå‘ç°ï¼šåŸæ¥ç¼–å†™å¾®æœåŠ¡å¦‚æ­¤ç®€å•ï¼

## 1. ä»€ä¹ˆæ˜¯çŸ­é“¾æœåŠ¡

çŸ­é“¾æœåŠ¡å°±æ˜¯å°†é•¿çš„URLç½‘å€ï¼Œé€šè¿‡ç¨‹åºè®¡ç®—ç­‰æ–¹å¼ï¼Œè½¬æ¢ä¸ºç®€çŸ­çš„ç½‘å€å­—ç¬¦ä¸²ã€‚

å†™æ­¤çŸ­é“¾æœåŠ¡æ˜¯ä¸ºäº†ä»æ•´ä½“ä¸Šæ¼”ç¤ºgo-zeroæ„å»ºå®Œæ•´å¾®æœåŠ¡çš„è¿‡ç¨‹ï¼Œç®—æ³•å’Œå®ç°ç»†èŠ‚å°½å¯èƒ½ç®€åŒ–äº†ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯ä¸€ä¸ªé«˜é˜¶çš„çŸ­é“¾æœåŠ¡ã€‚

## 2. çŸ­é“¾å¾®æœåŠ¡æ¶æ„å›¾

<img src="images/shorturl-arch.png" alt="æ¶æ„å›¾" width="800" />

* è¿™é‡Œåªç”¨äº†`Transform RPC`ä¸€ä¸ªå¾®æœåŠ¡ï¼Œå¹¶ä¸æ˜¯è¯´API Gatewayåªèƒ½è°ƒç”¨ä¸€ä¸ªå¾®æœåŠ¡ï¼Œåªæ˜¯ä¸ºäº†æœ€ç®€æ¼”ç¤ºAPI Gatewayå¦‚ä½•è°ƒç”¨RPCå¾®æœåŠ¡è€Œå·²
* åœ¨çœŸæ­£é¡¹ç›®é‡Œè¦å°½å¯èƒ½æ¯ä¸ªå¾®æœåŠ¡ä½¿ç”¨è‡ªå·±çš„æ•°æ®åº“ï¼Œæ•°æ®è¾¹ç•Œè¦æ¸…æ™°

## 3. goctlå„å±‚ä»£ç ç”Ÿæˆä¸€è§ˆ

æ‰€æœ‰ç»¿è‰²èƒŒæ™¯çš„åŠŸèƒ½æ¨¡å—æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼ŒæŒ‰éœ€æ¿€æ´»ï¼Œçº¢è‰²æ¨¡å—æ˜¯éœ€è¦è‡ªå·±å†™çš„ï¼Œä¹Ÿå°±æ˜¯å¢åŠ ä¸‹ä¾èµ–ï¼Œç¼–å†™ä¸šåŠ¡ç‰¹æœ‰é€»è¾‘ï¼Œå„å±‚ç¤ºæ„å›¾åˆ†åˆ«å¦‚ä¸‹ï¼š

* API Gateway

  <img src="images/shorturl-api.png" alt="api" width="800" />

* RPC

  <img src="images/shorturl-rpc.png" alt="æ¶æ„å›¾" width="800" />

* model

  <img src="images/shorturl-model.png" alt="model" width="800" />

ä¸‹é¢æˆ‘ä»¬æ¥ä¸€èµ·å®Œæ•´èµ°ä¸€éå¿«é€Ÿæ„å»ºå¾®æœåŠ¡çš„æµç¨‹ï¼ŒLetâ€™s `Go`!ğŸƒâ€â™‚ï¸

## 4. å‡†å¤‡å·¥ä½œ

* å®‰è£…etcd, mysql, redis

* å®‰è£…`protoc-gen-go`

  ```shell
  go get -u github.com/golang/protobuf/protoc-gen-go
  ```

* å®‰è£…goctlå·¥å…·

  ```shell
  GO111MODULE=on GOPROXY=https://goproxy.cn/,direct go get -u github.com/tal-tech/go-zero/tools/goctl
  ```

* åˆ›å»ºå·¥ä½œç›®å½• `shorturl` å’Œ `shorturl/api`

* åœ¨`shorturl`ç›®å½•ä¸‹æ‰§è¡Œ`go mod init shorturl`åˆå§‹åŒ–`go.mod`

## 5. ç¼–å†™API Gatewayä»£ç 

* åœ¨`shorturl/api`ç›®å½•ä¸‹é€šè¿‡goctlç”Ÿæˆ`api/shorturl.api`ï¼š

  ```shell
  goctl api -o shorturl.api
  ```

* ç¼–è¾‘`api/shorturl.api`ï¼Œä¸ºäº†ç®€æ´ï¼Œå»é™¤äº†æ–‡ä»¶å¼€å¤´çš„`info`ï¼Œä»£ç å¦‚ä¸‹ï¼š

  ```go
  type (
  	expandReq struct {
  		shorten string `form:"shorten"`
  	}
  
  	expandResp struct {
  		url string `json:"url"`
  	}
  )
  
  type (
  	shortenReq struct {
  		url string `form:"url"`
  	}
  
  	shortenResp struct {
  		shorten string `json:"shorten"`
  	}
  )
  
  service shorturl-api {
  	@server(
  		handler: ShortenHandler
  	)
  	get /shorten(shortenReq) returns(shortenResp)
  
  	@server(
  		handler: ExpandHandler
  	)
  	get /expand(expandReq) returns(expandResp)
  }
  ```

  typeç”¨æ³•å’Œgoä¸€è‡´ï¼Œserviceç”¨æ¥å®šä¹‰get/post/head/deleteç­‰apiè¯·æ±‚ï¼Œè§£é‡Šå¦‚ä¸‹ï¼š

  * `service shorturl-api {`è¿™ä¸€è¡Œå®šä¹‰äº†serviceåå­—
  * `@server`éƒ¨åˆ†ç”¨æ¥å®šä¹‰serverç«¯ç”¨åˆ°çš„å±æ€§
  * `handler`å®šä¹‰äº†æœåŠ¡ç«¯handleråå­—
  * `get /shorten(shortenReq) returns(shortenResp)`å®šä¹‰äº†getæ–¹æ³•çš„è·¯ç”±ã€è¯·æ±‚å‚æ•°ã€è¿”å›å‚æ•°ç­‰

* ä½¿ç”¨goctlç”ŸæˆAPI Gatewayä»£ç 

  ```shell
  goctl api go -api shorturl.api -dir .
  ```

  ç”Ÿæˆçš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

  ```Plain Text
  .
  â”œâ”€â”€ api
  â”‚Â Â  â”œâ”€â”€ etc
  â”‚Â Â  â”‚Â Â  â””â”€â”€ shorturl-api.yaml         // é…ç½®æ–‡ä»¶
  â”‚Â Â  â”œâ”€â”€ internal
  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ config
  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ config.go             // å®šä¹‰é…ç½®
  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ handler
  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ expandhandler.go      // å®ç°expandHandler
  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ routes.go             // å®šä¹‰è·¯ç”±å¤„ç†
  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ shortenhandler.go     // å®ç°shortenHandler
  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ logic
  â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ expandlogic.go        // å®ç°ExpandLogic
  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ shortenlogic.go       // å®ç°ShortenLogic
  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ svc
  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ servicecontext.go     // å®šä¹‰ServiceContext
  â”‚Â Â  â”‚Â Â  â””â”€â”€ types
  â”‚Â Â  â”‚Â Â      â””â”€â”€ types.go              // å®šä¹‰è¯·æ±‚ã€è¿”å›ç»“æ„ä½“
  â”‚Â Â  â”œâ”€â”€ shorturl.api
  â”‚Â Â  â””â”€â”€ shorturl.go                   // mainå…¥å£å®šä¹‰
  â”œâ”€â”€ go.mod
  â””â”€â”€ go.sum
  ```

* å¯åŠ¨API GatewayæœåŠ¡ï¼Œé»˜è®¤ä¾¦å¬åœ¨8888ç«¯å£

  ```shell
  go run shorturl.go -f etc/shorturl-api.yaml
  ```

* æµ‹è¯•API GatewayæœåŠ¡

  ```shell
  curl -i "http://localhost:8888/shorten?url=http://www.xiaoheiban.cn"
  ```

  è¿”å›å¦‚ä¸‹ï¼š

  ```http
  HTTP/1.1 200 OK
  Content-Type: application/json
  Date: Thu, 27 Aug 2020 14:31:39 GMT
  Content-Length: 15
  
  {"shortUrl":""}
  ```

  å¯ä»¥çœ‹åˆ°æˆ‘ä»¬API Gatewayå…¶å®å•¥ä¹Ÿæ²¡å¹²ï¼Œå°±è¿”å›äº†ä¸ªç©ºå€¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šåœ¨rpcæœåŠ¡é‡Œå®ç°ä¸šåŠ¡é€»è¾‘

* å¯ä»¥ä¿®æ”¹`internal/svc/servicecontext.go`æ¥ä¼ é€’æœåŠ¡ä¾èµ–ï¼ˆå¦‚æœéœ€è¦ï¼‰

* å®ç°é€»è¾‘å¯ä»¥ä¿®æ”¹`internal/logic`ä¸‹çš„å¯¹åº”æ–‡ä»¶

* å¯ä»¥é€šè¿‡`goctl`ç”Ÿæˆå„ç§å®¢æˆ·ç«¯è¯­è¨€çš„apiè°ƒç”¨ä»£ç 

* åˆ°è¿™é‡Œï¼Œä½ å·²ç»å¯ä»¥é€šè¿‡goctlç”Ÿæˆå®¢æˆ·ç«¯ä»£ç ç»™å®¢æˆ·ç«¯åŒå­¦å¹¶è¡Œå¼€å‘äº†ï¼Œæ”¯æŒå¤šç§è¯­è¨€ï¼Œè¯¦è§æ–‡æ¡£

## 6. ç¼–å†™transform rpcæœåŠ¡

- åœ¨ `shorturl` ç›®å½•ä¸‹åˆ›å»º `rpc` ç›®å½•

* åœ¨`rpc/transform`ç›®å½•ä¸‹ç¼–å†™`transform.proto`æ–‡ä»¶

  å¯ä»¥é€šè¿‡å‘½ä»¤ç”Ÿæˆprotoæ–‡ä»¶æ¨¡æ¿

  ```shell
  goctl rpc template -o transform.proto
  ```

  ä¿®æ”¹åæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

  ```protobuf
  syntax = "proto3";
  
  package transform;
  
  message expandReq {
      string shorten = 1;
  }
  
  message expandResp {
      string url = 1;
  }
  
  message shortenReq {
      string url = 1;
  }
  
  message shortenResp {
      string shorten = 1;
  }
  
  service transformer {
      rpc expand(expandReq) returns(expandResp);
      rpc shorten(shortenReq) returns(shortenResp);
  }
  ```

* ç”¨`goctl`ç”Ÿæˆrpcä»£ç ï¼Œåœ¨`rpc/transform`ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤

  ```shell
  goctl rpc proto -src transform.proto
  ```

  æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

  ```Plain Text
  rpc/transform
  â”œâ”€â”€ etc
  â”‚Â Â  â””â”€â”€ transform.yaml              // é…ç½®æ–‡ä»¶
  â”œâ”€â”€ internal
  â”‚Â Â  â”œâ”€â”€ config
  â”‚Â Â  â”‚Â Â  â””â”€â”€ config.go               // é…ç½®å®šä¹‰
  â”‚Â Â  â”œâ”€â”€ logic
  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ expandlogic.go          // expandä¸šåŠ¡é€»è¾‘åœ¨è¿™é‡Œå®ç°
  â”‚Â Â  â”‚Â Â  â””â”€â”€ shortenlogic.go         // shortenä¸šåŠ¡é€»è¾‘åœ¨è¿™é‡Œå®ç°
  â”‚Â Â  â”œâ”€â”€ server
  â”‚Â Â  â”‚Â Â  â””â”€â”€ transformerserver.go    // è°ƒç”¨å…¥å£, ä¸éœ€è¦ä¿®æ”¹
  â”‚Â Â  â””â”€â”€ svc
  â”‚Â Â      â””â”€â”€ servicecontext.go       // å®šä¹‰ServiceContextï¼Œä¼ é€’ä¾èµ–
  â”œâ”€â”€ pb
  â”‚Â Â  â””â”€â”€ transform.pb.go
  â”œâ”€â”€ transform.go                    // rpcæœåŠ¡mainå‡½æ•°
  â”œâ”€â”€ transform.proto
  â””â”€â”€ transformer
      â”œâ”€â”€ transformer.go              // æä¾›äº†å¤–éƒ¨è°ƒç”¨æ–¹æ³•ï¼Œæ— éœ€ä¿®æ”¹
      â”œâ”€â”€ transformer_mock.go         // mockæ–¹æ³•ï¼Œæµ‹è¯•ç”¨
      â””â”€â”€ types.go                    // request/responseç»“æ„ä½“å®šä¹‰
  ```

  ç›´æ¥å¯ä»¥è¿è¡Œï¼Œå¦‚ä¸‹ï¼š

  ```shell
  $ go run transform.go -f etc/transform.yaml
  Starting rpc server at 127.0.0.1:8080...
  ```

  `etc/transform.yaml`æ–‡ä»¶é‡Œå¯ä»¥ä¿®æ”¹ä¾¦å¬ç«¯å£ç­‰é…ç½®

## 7. ä¿®æ”¹API Gatewayä»£ç è°ƒç”¨transform rpcæœåŠ¡

* ä¿®æ”¹é…ç½®æ–‡ä»¶`shorturl-api.yaml`ï¼Œå¢åŠ å¦‚ä¸‹å†…å®¹

  ```yaml
  Transform:
    Etcd:
      Hosts:
        - localhost:2379
      Key: transform.rpc
  ```

  é€šè¿‡etcdè‡ªåŠ¨å»å‘ç°å¯ç”¨çš„transformæœåŠ¡

* ä¿®æ”¹`internal/config/config.go`å¦‚ä¸‹ï¼Œå¢åŠ transformæœåŠ¡ä¾èµ–

  ```go
  type Config struct {
  	rest.RestConf
  	Transform zrpc.RpcClientConf     // æ‰‹åŠ¨ä»£ç 
  }
  ```

* ä¿®æ”¹`internal/svc/servicecontext.go`ï¼Œå¦‚ä¸‹ï¼š

  ```go
  type ServiceContext struct {
  	Config    config.Config
  	Transformer transformer.Transformer                                          // æ‰‹åŠ¨ä»£ç 
  }
  
  func NewServiceContext(c config.Config) *ServiceContext {
  	return &ServiceContext{
  		Config:    c,
      Transformer: transformer.NewTransformer(zrpc.MustNewClient(c.Transform)),  // æ‰‹åŠ¨ä»£ç 
  	}
  }
  ```

  é€šè¿‡ServiceContextåœ¨ä¸åŒä¸šåŠ¡é€»è¾‘ä¹‹é—´ä¼ é€’ä¾èµ–

* ä¿®æ”¹`internal/logic/expandlogic.go`é‡Œçš„`Expand`æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

  ```go
  func (l *ExpandLogic) Expand(req types.ExpandReq) (*types.ExpandResp, error) {
    // æ‰‹åŠ¨ä»£ç å¼€å§‹
  	resp, err := l.svcCtx.Transformer.Expand(l.ctx, &transformer.ExpandReq{
  		Shorten: req.Shorten,
  	})
  	if err != nil {
  		return nil, err
  	}
  
  	return &types.ExpandResp{
  		Url: resp.Url,
  	}, nil
    // æ‰‹åŠ¨ä»£ç ç»“æŸ
  }
  ```

é€šè¿‡è°ƒç”¨`transformer`çš„`Expand`æ–¹æ³•å®ç°çŸ­é“¾æ¢å¤åˆ°url

* ä¿®æ”¹`internal/logic/shortenlogic.go`ï¼Œå¦‚ä¸‹ï¼š

  ```go
  func (l *ShortenLogic) Shorten(req types.ShortenReq) (*types.ShortenResp, error) {
    // æ‰‹åŠ¨ä»£ç å¼€å§‹
  	resp, err := l.svcCtx.Transformer.Shorten(l.ctx, &transformer.ShortenReq{
  		Url: req.Url,
  	})
  	if err != nil {
  		return nil, err
  	}
  
  	return &types.ShortenResp{
  		Shorten: resp.Shorten,
  	}, nil
    // æ‰‹åŠ¨ä»£ç ç»“æŸ
  }
  ```

é€šè¿‡è°ƒç”¨`transformer`çš„`Shorten`æ–¹æ³•å®ç°urlåˆ°çŸ­é“¾çš„å˜æ¢

è‡³æ­¤ï¼ŒAPI Gatewayä¿®æ”¹å®Œæˆï¼Œè™½ç„¶è´´çš„ä»£ç å¤šï¼Œä½†æ˜¯æœŸä¸­ä¿®æ”¹çš„æ˜¯å¾ˆå°‘çš„ä¸€éƒ¨åˆ†ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£ä¸Šä¸‹æ–‡ï¼Œæˆ‘è´´äº†å®Œæ•´ä»£ç ï¼Œæ¥ä¸‹æ¥å¤„ç†CRUD+cache

## 8. å®šä¹‰æ•°æ®åº“è¡¨ç»“æ„ï¼Œå¹¶ç”ŸæˆCRUD+cacheä»£ç 

* shorturlä¸‹åˆ›å»º`rpc/transform/model`ç›®å½•ï¼š`mkdir -p rpc/transform/model`

* åœ¨rpc/transform/modelç›®å½•ä¸‹ç¼–å†™åˆ›å»ºshorturlè¡¨çš„sqlæ–‡ä»¶`shorturl.sql`ï¼Œå¦‚ä¸‹ï¼š

  ```sql
  CREATE TABLE `shorturl`
  (
    `shorten` varchar(255) NOT NULL COMMENT 'shorten key',
    `url` varchar(255) NOT NULL COMMENT 'original url',
    PRIMARY KEY(`shorten`)
  ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
  ```

* åˆ›å»ºDBå’Œtable

  ```sql
  create database gozero;
  ```

  ```sql
  source shorturl.sql;
  ```

* åœ¨`rpc/transform/model`ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç”ŸæˆCRUD+cacheä»£ç ï¼Œ`-c`è¡¨ç¤ºä½¿ç”¨`redis cache`

  ```shell
  goctl model mysql ddl -c -src shorturl.sql -dir .
  ```

  ä¹Ÿå¯ä»¥ç”¨`datasource`å‘½ä»¤ä»£æ›¿`ddl`æ¥æŒ‡å®šæ•°æ®åº“é“¾æ¥ç›´æ¥ä»schemaç”Ÿæˆ

  ç”Ÿæˆåçš„æ–‡ä»¶ç»“æ„å¦‚ä¸‹ï¼š

  ```Plain Text
  rpc/transform/model
  â”œâ”€â”€ shorturl.sql
  â”œâ”€â”€ shorturlmodel.go              // CRUD+cacheä»£ç 
  â””â”€â”€ vars.go                       // å®šä¹‰å¸¸é‡å’Œå˜é‡
  ```

## 9. ä¿®æ”¹shorten/expand rpcä»£ç è°ƒç”¨crud+cacheä»£ç 

* ä¿®æ”¹`rpc/transform/etc/transform.yaml`ï¼Œå¢åŠ å¦‚ä¸‹å†…å®¹ï¼š

  ```yaml
  DataSource: root:@tcp(localhost:3306)/gozero
  Table: shorturl
  Cache:
    - Host: localhost:6379
  ```

  å¯ä»¥ä½¿ç”¨å¤šä¸ªredisä½œä¸ºcacheï¼Œæ”¯æŒrediså•ç‚¹æˆ–è€…redisé›†ç¾¤

* ä¿®æ”¹`rpc/transform/internal/config.go`ï¼Œå¦‚ä¸‹ï¼š

  ```go
  type Config struct {
  	zrpc.RpcServerConf
  	DataSource string             // æ‰‹åŠ¨ä»£ç 
  	Table      string             // æ‰‹åŠ¨ä»£ç 
  	Cache      cache.CacheConf    // æ‰‹åŠ¨ä»£ç 
  }
  ```

  å¢åŠ äº†mysqlå’Œredis cacheé…ç½®

* ä¿®æ”¹`rpc/transform/internal/svc/servicecontext.go`ï¼Œå¦‚ä¸‹ï¼š

  ```go
  type ServiceContext struct {
  	c     config.Config
    Model *model.ShorturlModel   // æ‰‹åŠ¨ä»£ç 
  }
  
  func NewServiceContext(c config.Config) *ServiceContext {
  	return &ServiceContext{
  		c:             c,
  		Model: model.NewShorturlModel(sqlx.NewMysql(c.DataSource), c.Cache, c.Table), // æ‰‹åŠ¨ä»£ç 
  	}
  }
  ```

* ä¿®æ”¹`rpc/transform/internal/logic/expandlogic.go`ï¼Œå¦‚ä¸‹ï¼š

  ```go
  func (l *ExpandLogic) Expand(in *transform.ExpandReq) (*transform.ExpandResp, error) {
  	// æ‰‹åŠ¨ä»£ç å¼€å§‹
  	res, err := l.svcCtx.Model.FindOne(in.Shorten)
  	if err != nil {
  		return nil, err
  	}
  
  	return &transform.ExpandResp{
  		Url: res.Url,
  	}, nil
  	// æ‰‹åŠ¨ä»£ç ç»“æŸ
  }
  ```

* ä¿®æ”¹`rpc/shorten/internal/logic/shortenlogic.go`ï¼Œå¦‚ä¸‹ï¼š

  ```go
  func (l *ShortenLogic) Shorten(in *transform.ShortenReq) (*transform.ShortenResp, error) {
    // æ‰‹åŠ¨ä»£ç å¼€å§‹ï¼Œç”ŸæˆçŸ­é“¾æ¥
  	key := hash.Md5Hex([]byte(in.Url))[:6]
  	_, err := l.svcCtx.Model.Insert(model.Shorturl{
  		Shorten: key,
  		Url:     in.Url,
  	})
  	if err != nil {
  		return nil, err
  	}
  
  	return &transform.ShortenResp{
  		Shorten: key,
  	}, nil
    // æ‰‹åŠ¨ä»£ç ç»“æŸ
  }
  ```

  è‡³æ­¤ä»£ç ä¿®æ”¹å®Œæˆï¼Œå‡¡æ˜¯æ‰‹åŠ¨ä¿®æ”¹çš„ä»£ç æˆ‘åŠ äº†æ ‡æ³¨

## 10. å®Œæ•´è°ƒç”¨æ¼”ç¤º

* shorten apiè°ƒç”¨

  ```shell
  curl -i "http://localhost:8888/shorten?url=http://www.xiaoheiban.cn"
  ```

  è¿”å›å¦‚ä¸‹ï¼š

  ```http
  HTTP/1.1 200 OK
  Content-Type: application/json
  Date: Sat, 29 Aug 2020 10:49:49 GMT
  Content-Length: 21
  
  {"shorten":"f35b2a"}
  ```

* expand apiè°ƒç”¨

  ```shell
  curl -i "http://localhost:8888/expand?shorten=f35b2a"
  ```

  è¿”å›å¦‚ä¸‹ï¼š

  ```http
  HTTP/1.1 200 OK
  Content-Type: application/json
  Date: Sat, 29 Aug 2020 10:51:53 GMT
  Content-Length: 34
  
  {"url":"http://www.xiaoheiban.cn"}
  ```

## 11. Benchmark

å› ä¸ºå†™å…¥ä¾èµ–äºmysqlçš„å†™å…¥é€Ÿåº¦ï¼Œå°±ç›¸å½“äºå‹mysqläº†ï¼Œæ‰€ä»¥å‹æµ‹åªæµ‹è¯•äº†expandæ¥å£ï¼Œç›¸å½“äºä»mysqlé‡Œè¯»å–å¹¶åˆ©ç”¨ç¼“å­˜ï¼Œshorten.luaé‡Œéšæœºä»dbé‡Œè·å–äº†100ä¸ªçƒ­keyæ¥ç”Ÿæˆå‹æµ‹è¯·æ±‚

![Benchmark](images/shorturl-benchmark.png)

å¯ä»¥çœ‹å‡ºåœ¨æˆ‘çš„MacBook Proä¸Šèƒ½è¾¾åˆ°3ä¸‡+çš„qpsã€‚

## 12. å®Œæ•´ä»£ç 

[https://github.com/tal-tech/go-zero/tree/master/example/shorturl](https://github.com/tal-tech/go-zero/tree/master/example/shorturl)

## 12. æ€»ç»“

æˆ‘ä»¬ä¸€ç›´å¼ºè°ƒ**å·¥å…·å¤§äºçº¦å®šå’Œæ–‡æ¡£**ã€‚

go-zeroä¸åªæ˜¯ä¸€ä¸ªæ¡†æ¶ï¼Œæ›´æ˜¯ä¸€ä¸ªå»ºç«‹åœ¨æ¡†æ¶+å·¥å…·åŸºç¡€ä¸Šçš„ï¼Œç®€åŒ–å’Œè§„èŒƒäº†æ•´ä¸ªå¾®æœåŠ¡æ„å»ºçš„æŠ€æœ¯ä½“ç³»ã€‚

æˆ‘ä»¬åœ¨ä¿æŒç®€å•çš„åŒæ—¶ä¹Ÿå°½å¯èƒ½æŠŠå¾®æœåŠ¡æ²»ç†çš„å¤æ‚åº¦å°è£…åˆ°äº†æ¡†æ¶å†…éƒ¨ï¼Œæå¤§çš„é™ä½äº†å¼€å‘äººå‘˜çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œä½¿å¾—ä¸šåŠ¡å¼€å‘å¾—ä»¥å¿«é€Ÿæ¨è¿›ã€‚

é€šè¿‡go-zero+goctlç”Ÿæˆçš„ä»£ç ï¼ŒåŒ…å«äº†å¾®æœåŠ¡æ²»ç†çš„å„ç§ç»„ä»¶ï¼ŒåŒ…æ‹¬ï¼šå¹¶å‘æ§åˆ¶ã€è‡ªé€‚åº”ç†”æ–­ã€è‡ªé€‚åº”é™è½½ã€è‡ªåŠ¨ç¼“å­˜æ§åˆ¶ç­‰ï¼Œå¯ä»¥è½»æ¾éƒ¨ç½²ä»¥æ‰¿è½½å·¨å¤§è®¿é—®é‡ã€‚

æœ‰ä»»ä½•å¥½çš„æå‡å·¥ç¨‹æ•ˆç‡çš„æƒ³æ³•ï¼Œéšæ—¶æ¬¢è¿äº¤æµï¼ğŸ‘
